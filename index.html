<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Learning App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="buttons">
            <button id="analyzeImage" class="button">Analyze Image</button>
            <button id="play-audio" class="button">Play Audio</button>
            <button id="lookup-word">Lookup Word</button>
            <button id="translate">Translate to Chinese</button>
            <div class="dictionary-select">
                <label>Dictionary Type:</label>
                <label>
                    <input type="radio" name="dictionary" value="english" checked> 
                    English (Hover)
                </label>
                <label>
                    <input type="radio" name="dictionary" value="chinese"> 
                    Chinese (Select)
                </label>
            </div>
        </div>
        <div id="imageModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Image Analysis</h2>
                <div class="mode-select">
                    <label>
                        <input type="radio" name="mode" value="ocr" checked> 
                        文字识别 (OCR)
                    </label>
                    <label>
                        <input type="radio" name="mode" value="description"> 
                        图片描述
                    </label>
                </div>
                <div class="file-input">
                    <input type="file" id="imageFile" accept="image/*">
                </div>
                <button id="analyzeButton" class="button">Analyze</button>
                <div id="analysisResult"></div>
            </div>
        </div>
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h2>Confirm Replacement</h2>
                <p>Do you want to replace the current passage with the OCR result?</p>
                <div class="modal-buttons">
                    <button id="confirmYes" class="button">Yes</button>
                    <button id="confirmNo" class="button">No</button>
                </div>
            </div>
        </div>
        <table class="content-table">
            <tr>
                <th>English Comprehension Passage</th>
                <th>中文翻译</th>
            </tr>
            <tr>
                <td id="passage">
                    <p><span class="word">Once</span> <span class="word">upon</span> <span class="word">a</span> <span class="word">time</span>, <span class="word">in</span> <span class="word">a</span> <span class="word">land</span> <span class="word">far</span> <span class="word">away</span>, <span class="word">there</span> <span class="word">was</span> <span class="word">a</span> <span class="word">small</span> <span class="word">village</span> <span class="word">surrounded</span> <span class="word">by</span> <span class="word">lush</span> <span class="word">green</span> <span class="word">forests</span>...
                    </p>
                    <p><span class="word">The</span> <span class="word">villagers</span> <span class="word">lived</span> <span class="word">in</span> <span class="word">harmony</span> <span class="word">with</span> <span class="word">nature</span>, <span class="word">celebrating</span> <span class="word">the</span> <span class="word">changing</span> <span class="word">seasons</span> <span class="word">and</span> <span class="word">the</span> <span class="word">bounty</span> <span class="word">it</span> <span class="word">brought</span>. <span class="word">Every</span> <span class="word">year</span>, <span class="word">they</span> <span class="word">held</span> <span class="word">a</span> <span class="word">festival</span> <span class="word">to</span> <span class="word">thank</span> <span class="word">the</span> <span class="word">forest</span> <span class="word">for</span> <span class="word">its</span> <span class="word">gifts</span>.</p>
                    <p><span class="word">One</span> <span class="word">day</span>, <span class="word">a</span> <span class="word">stranger</span> <span class="word">arrived</span> <span class="word">in</span> <span class="word">the</span> <span class="word">village</span>. <span class="word">He</span> <span class="word">was</span> <span class="word">a</span> <span class="word">traveler</span> <span class="word">from</span> <span class="word">a</span> <span class="word">distant</span> <span class="word">land</span>, <span class="word">seeking</span> <span class="word">shelter</span> <span class="word">and</span> <span class="word">food</span>. <span class="word">The</span> <span class="word">villagers</span> <span class="word">welcomed</span> <span class="word">him</span> <span class="word">warmly</span>.</p>
                    <p><span class="word">As</span> <span class="word">the</span> <span class="word">days</span> <span class="word">passed</span>, <span class="word">the</span> <span class="word">stranger</span> <span class="word">shared</span> <span class="word">stories</span> <span class="word">of</span> <span class="word">his</span> <span class="word">travels</span>, <span class="word">filling</span> <span class="word">the</span> <span class="word">villagers'</span> <span class="word">minds</span> <span class="word">with</span> <span class="word">wonder</span> <span class="word">and</span> <span class="word">curiosity</span>. <span class="word">He</span> <span class="word">spoke</span> <span class="word">of</span> <span class="word">mountains</span> <span class="word">that</span> <span class="word">touched</span> <span class="word">the</span> <span class="word">sky</span> <span class="word">and</span> <span class="word">oceans</span> <span class="word">that</span> <span class="word">stretched</span> <span class="word">beyond</span> <span class="word">the</span> <span class="word">horizon</span>.</p>
                    <p><span class="word">Inspired</span> <span class="word">by</span> <span class="word">his</span> <span class="word">tales</span>, <span class="word">some</span> <span class="word">of</span> <span class="word">the</span> <span class="word">young</span> <span class="word">villagers</span> <span class="word">decided</span> <span class="word">to</span> <span class="word">embark</span> <span class="word">on</span> <span class="word">their</span> <span class="word">own</span> <span class="word">journeys</span>, <span class="word">eager</span> <span class="word">to</span> <span class="word">see</span> <span class="word">the</span> <span class="word">world</span> <span class="word">beyond</span> <span class="word">their</span> <span class="word">village</span>. <span class="word">And</span> <span class="word">so</span>, <span class="word">the</span> <span class="word">spirit</span> <span class="word">of</span> <span class="word">adventure</span> <span class="word">was</span> <span class="word">born</span> <span class="word">in</span> <span class="word">the</span> <span class="word">hearts</span> <span class="word">of</span> <span class="word">the</span> <span class="word">villagers</span>.</p>
                </td>
                <td id="translation">
                    <p>Translation will appear here...</p>
                </td>
            </tr>
        </table>
    </div>
    <div id="tooltip" style="display: none; position: absolute; background-color: #fff; border: 1px solid #ccc; padding: 5px; border-radius: 4px;"></div>
    <div id="loading">Translating...</div>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .mode-select {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .mode-select label {
            margin-right: 20px;
            cursor: pointer;
        }
        #analysisResult {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
        }
        .modal-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .modal-buttons button {
            margin: 0 10px;
        }
    </style>
    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        const imageModal = document.getElementById('imageModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeBtn = document.querySelector('.close');
        let ocrResult = '';
        document.getElementById('analyzeImage').onclick = function() {
            imageModal.style.display = 'block';
        }
        closeBtn.onclick = function() {
            imageModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == imageModal) {
                imageModal.style.display = 'none';
            }
            if (event.target == confirmModal) {
                confirmModal.style.display = 'none';
            }
        }
        document.getElementById('analyzeButton').onclick = async function() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an image file first');
                return;
            }
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const prompt = mode === 'ocr' 
                ? "请识别图片中的所有文字，并按段落格式整理输出。"
                : "请详细描述这张图片的内容，包括主要对象、场景、动作和氛围等细节。";
            const button = this;
            const resultDiv = document.getElementById('analysisResult');
            
            button.disabled = true;
            button.textContent = 'Analyzing...';
            resultDiv.textContent = 'Processing image...';
            try {
                const dataUrl = await fileToDataUrl(file);
                const response = await fetch('https://api-proxy579.deno.dev/aliyun', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CONFIG.DASHSCOPE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "model": "qwen-vl-max-latest",
                        "input": {
                            "messages": [
                                {
                                    "role": "system",
                                    "content": [
                                        {"text": "You are a helpful assistant."}
                                    ]
                                },
                                {
                                    "role": "user",
                                    "content": [
                                        {
                                            "image": dataUrl
                                        },
                                        {
                                            "text": prompt
                                        }
                                    ]
                                }
                            ]
                        }
                    })
                });
                const data = await response.json();
                const result = data.output.choices[0].message.content[0].text;
                if (mode === 'ocr') {
                    ocrResult = result;
                    confirmModal.style.display = 'block';
                    imageModal.style.display = 'none';
                } else {
                    resultDiv.textContent = result;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.textContent = 'Error analyzing image: ' + error.message;
            } finally {
                button.disabled = false;
                button.textContent = 'Analyze';
            }
        }
        document.getElementById('confirmYes').onclick = function() {
            const passageDiv = document.getElementById('passage');
            const paragraphs = ocrResult.split('\n').filter(p => p.trim());
            passageDiv.innerHTML = paragraphs.map(p => 
                `<p>${p.split(' ').map(word => 
                    `<span class="word">${word}</span>`
                ).join(' ')}</p>`
            ).join('');
            confirmModal.style.display = 'none';
            attachWordListeners();
        }
        document.getElementById('confirmNo').onclick = function() {
            confirmModal.style.display = 'none';
            imageModal.style.display = 'block';
        }
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        function attachWordListeners() {
            document.querySelectorAll('.word').forEach(wordElement => {
                wordElement.addEventListener('mouseenter', handleWordHover);
                wordElement.addEventListener('mouseleave', handleWordLeave);
            });
        }
    </script>
</body>
</html> 